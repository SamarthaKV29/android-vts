package fuzion24.device.vulnerability.vulnerabilities;

import android.util.Log;
import android.util.Pair;

import com.nowsecure.android.vts.BuildConfig;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import java.util.List;

import fuzion24.device.vulnerability.test.VulnerabilityDescriptor;
import fuzion24.device.vulnerability.test.VulnerabilityTestResult;
import fuzion24.device.vulnerability.util.DeviceInfo;

/**
 * Created by fuzion24 on 11/25/15.
 */
public class VulnerabilityResultSerialzier {

    private VulnerabilityResultSerialzier() {
    }

    public static JSONObject serializeResultsToJson(List<VulnerabilityTestResult> results, DeviceInfo devInfo) throws JSONException {
        // not sure if this is too intense to do on the main thread...
        JSONArray testResults = new JSONArray();
        JSONObject buildInfo = new JSONObject();
        JSONObject combinedResults = new JSONObject();

        buildInfo.put("fingerprint", devInfo.getBuildFingerPrint());
        buildInfo.put("kernelVersion", devInfo.getKernelVersion());
        buildInfo.put("brand", devInfo.getBuildBrand());
        buildInfo.put("manufacturer", devInfo.getBuildManufacturer());
        buildInfo.put("model", devInfo.getBuildModel());
        buildInfo.put("release", devInfo.getBuildRelease());
        buildInfo.put("sdk", devInfo.getBuildSDK());
        buildInfo.put("builddate", devInfo.getBuildDateUTC());
        buildInfo.put("id", devInfo.getBuildID());
        buildInfo.put("cpuABI", devInfo.getBuildCpuABI());
        buildInfo.put("cpuABI2", devInfo.getBuildCpuABI2());

        JSONArray supportedABIs = new JSONArray();
        for(String abi :  devInfo.getSupportedABIS()){
            supportedABIs.put(abi);
        }

        buildInfo.put("supportedABIs", supportedABIs);
        buildInfo.put("versionCode", BuildConfig.VERSION_CODE);
        buildInfo.put("versionName", BuildConfig.VERSION_NAME);

        for (VulnerabilityTestResult s : results) {
            JSONObject res = new JSONObject();
            res.put("name", s.getCVEorID());
            res.put("isVulnerable", s.isVulnerable());
            res.put("exception", s.getException());
            testResults.put(res);
        }

        combinedResults.put("buildInfo", buildInfo);
        combinedResults.put("results", testResults);

        return combinedResults;
    }

    public static JSONObject serializeResultsWithDescToJSON(List<Pair<VulnerabilityTestResult, VulnerabilityDescriptor>> mResults, DeviceInfo devInfo) throws JSONException{
        // not sure if this is too intense to do on the main thread...
        JSONArray testResults = new JSONArray();
        JSONObject buildInfo = new JSONObject();
        JSONObject combinedResults = new JSONObject();

        buildInfo.put("fingerprint", devInfo.getBuildFingerPrint());
        buildInfo.put("kernelVersion", devInfo.getKernelVersion());
        buildInfo.put("brand", devInfo.getBuildBrand());
        buildInfo.put("manufacturer", devInfo.getBuildManufacturer());
        buildInfo.put("model", devInfo.getBuildModel());
        buildInfo.put("release", devInfo.getBuildRelease());
        buildInfo.put("sdk", devInfo.getBuildSDK());
        buildInfo.put("builddate", devInfo.getBuildDateUTC());
        buildInfo.put("id", devInfo.getBuildID());
        buildInfo.put("cpuABI", devInfo.getBuildCpuABI());
        buildInfo.put("cpuABI2", devInfo.getBuildCpuABI2());

        JSONArray supportedABIs = new JSONArray();
        for(String abi :  devInfo.getSupportedABIS()){
            supportedABIs.put(abi);
        }

        buildInfo.put("supportedABIs", supportedABIs);
        buildInfo.put("versionCode", BuildConfig.VERSION_CODE);
        buildInfo.put("versionName", BuildConfig.VERSION_NAME);

        for (Pair pair: mResults) {
            VulnerabilityTestResult s = (VulnerabilityTestResult) pair.first;
            VulnerabilityDescriptor d = (VulnerabilityDescriptor) pair.second;

            JSONObject res = new JSONObject();
            res.put("name", s.getCVEorID());
            res.put("description", d.getDescription());
            res.put("impact", d.getImpact());
            res.put("isVulnerable", s.isVulnerable());
            res.put("exception", s.getException());
            testResults.put(res);
        }

        combinedResults.put("buildInfo", buildInfo);
        combinedResults.put("results", testResults);

        return combinedResults;
    }

    public static String serializeResultsWithDescToReport(List<Pair<VulnerabilityTestResult, VulnerabilityDescriptor>> mResults, DeviceInfo devInfo){
        // not sure if this is too intense to do on the main thread...
        String result = "Android VTS Report\n";

        result += "========Device Information========\n\n";

        result += "Fingerprint: " + devInfo.getBuildFingerPrint() +"\n";
        result += "Kernel Version: " + devInfo.getKernelVersion() +"\n";
        result += "Brand: " + devInfo.getBuildBrand() +"\n";
        result += "Manufacturer: " + devInfo.getBuildManufacturer() +"\n";
        result += "Model: " + devInfo.getBuildModel() +"\n";
        result += "Release: " + devInfo.getBuildRelease() +"\n";
        result += "SDK: " + devInfo.getBuildSDK() +"\n";
        result += "Build Date: " + devInfo.getBuildDateUTC() +"\n";
        result += "ID: " + devInfo.getBuildID() +"\n";
        result += "CPU ABI: " + devInfo.getBuildCpuABI() +"\n";
        result += "CPU ABI2: " + devInfo.getBuildCpuABI2() +"\n";
        result += "Version Code: " + BuildConfig.VERSION_CODE +"\n";
        result += "Version Name: " + BuildConfig.VERSION_NAME +"\n";

        result += "\n\n========Test Results========\n\n";

        StringBuilder testResults = new StringBuilder();
        for (Pair pair: mResults) {
            VulnerabilityTestResult s = (VulnerabilityTestResult) pair.first;
            VulnerabilityDescriptor d = (VulnerabilityDescriptor) pair.second;
            
            testResults.append("===========================================================================================================================\n");
            testResults.append("Name: ").append(s.getCVEorID()).append("\n");
            testResults.append("Description: ").append(d.getDescription()).append("\n");
            testResults.append("Impact: ").append(d.getImpact()).append("\n");
            testResults.append("Vulnerable?: ").append(s.isVulnerable()).append("\n");
            testResults.append("Exception: ").append(s.getException()).append("\n");
            testResults.append("===========================================================================================================================\n");
        }

        result += testResults;
        Log.d("VulnerabilityTest", "serializeResultsWithDescToReport: \n" + result);
        return result;
    }

}
